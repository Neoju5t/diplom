# üöÄ –î–∏–ø–ª–æ–º–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ Yandex Cloud

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ Yandex Cloud —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Terraform** –∏ **Ansible**. –í–∫–ª—é—á–∞–µ—Ç:

- –í–µ–±-—Å–∞–π—Ç –Ω–∞ –¥–≤—É—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö (nginx) —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –ø–æ–º–æ—â—å—é Zabbix (USE-–º–µ—Ç—Ä–∏–∫–∏, –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
- –°–±–æ—Ä –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ Filebeat + Elasticsearch + Kibana
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ snapshot'—ã –≤—Å–µ—Ö –¥–∏—Å–∫–æ–≤ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º 7 –¥–Ω–µ–π
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–µ—Ç—å —Å bastion-—Ö–æ—Å—Ç–æ–º –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ –ø–æ–¥—Å–µ—Ç—è–º–∏

## üß∞ –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- üõ† Terraform
- ‚öôÔ∏è Ansible
- üß† Zabbix
- üì¶ Filebeat, Elasticsearch, Kibana
- üêß NGINX
- ‚òÅÔ∏è Yandex Cloud

## üñ•Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

Terraform
‚îú‚îÄ‚îÄ ansible
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ create_inventory.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ group_vars
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ all.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ inventory
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ output.json
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ production.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ roles
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ elasticsearch
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ filebeat
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ files
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ filebeat-8.12.2.tar
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ filebeat.yml.j2
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ kibana
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ files
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ kibana-8.12.2.tar
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ kibana-compose.j2
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ kibana-nginx.conf.j2
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ nginx
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ files
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ images
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ logo.png
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ site
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ about.html
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ index.html
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ styles.css
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ default-site.j2
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ zabbix_agent
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ defaults
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ restart.yml
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ zabbix_agentd.conf.j2
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ zabbix_server
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ defaults
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ handlers
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ tasks
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ansible.cfg
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.yml
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ zabbix.conf.j2
‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ zabbix_server.conf.j2
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ site.yml
‚îú‚îÄ‚îÄ main.tf
‚îú‚îÄ‚îÄ outputs.tf
‚îú‚îÄ‚îÄ providers.tf
‚îú‚îÄ‚îÄ scripts
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ deploy.sh
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ verify.sh
‚îú‚îÄ‚îÄ snapshots.tf
‚îú‚îÄ‚îÄ terraform.tfstate
‚îú‚îÄ‚îÄ terraform.tfstate.backup
‚îú‚îÄ‚îÄ terraform.tfvars
‚îî‚îÄ‚îÄ variables.tf

## üåê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –î–≤–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (nginx) –≤ —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω–∞—Ö –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö IP
- Application Load Balancer —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫
- Bastion host —Å –ø—É–±–ª–∏—á–Ω—ã–º IP –¥–ª—è SSH-–¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –í–ú
- NAT-–∏–Ω—Å—Ç–∞–Ω—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π —Å–µ—Ç–∏
- –í–ú –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –ø—É–±–ª–∏—á–Ω–æ–π –ø–æ–¥—Å–µ—Ç–∏

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í–ú –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ IP, –∫—Ä–æ–º–µ bastion
- ProxyCommand –≤ Ansible –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ bastion
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã Security Groups
- –¢–æ–∫–µ–Ω—ã –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ git

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Zabbix)

- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Zabbix Server + –∞–≥–µ–Ω—Ç—ã –Ω–∞ –≤—Å–µ—Ö —Ö–æ—Å—Ç–∞—Ö
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–µ—à–±–æ—Ä–¥—ã –ø–æ USE-–º–æ–¥–µ–ª–∏:
  - CPU, RAM, Disk, Network
  - HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞–º
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã threshold'—ã (–ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)

üì∑ _–ü—Ä–∏–º–µ—Ä Zabbix dashboard:_
![Zabbix Dashboard](./screenshots/zabbix_dashboard.png)

## üìë –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (ELK)

- Filebeat –Ω–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞—Ö –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç nginx `access.log` –∏ `error.log` –≤ Elasticsearch
- Kibana –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ Elasticsearch

üì∑ _–ü—Ä–∏–º–µ—Ä Kibana dashboard:_
![Kibana](./screenshots/kibana.png)

## üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã snapshot'—ã –≤—Å–µ—Ö –í–ú
- –°–æ–∑–¥–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 (UTC)
- –•—Ä–∞–Ω—è—Ç—Å—è 7 –¥–Ω–µ–π

## ‚öôÔ∏è –î–µ–ø–ª–æ–π

1. **–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**

cd terraform
terraform init
terraform apply

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –í–ú:** 

cd ansible
python3 create_inventory.py > inventory/output.json
ansible-playbook -i inventory/output.json site.yml

3. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤:**

üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç—ã

Zabbix

Kibana

–°–∞–π—Ç —á–µ—Ä–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ (curl)

–£—Å–ø–µ—à–Ω—ã–π terraform apply

üìÅ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è .ru-central1.internal DNS –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

Docker-–æ–±—Ä–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤—Ä—É—á–Ω—É—é (–≤ —Å–≤—è–∑–∏ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π docker.elastic.co)

Ansible –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å Mac —á–µ—Ä–µ–∑ bastion (—É–∫–∞–∑–∞–Ω ProxyCommand)
